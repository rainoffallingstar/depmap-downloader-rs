# SQLite 数据库连接错误修复

## 问题描述
当运行 `./depmap-downloader update` 时出现以下错误：
```
Database error: error returned from database: (code: 14) unable to open database file
```

## 根本原因
该错误是由于SQLite数据库的WAL(Write-Ahead Logging)文件丢失导致的：
- 数据库配置为WAL模式以提高并发性能
- 当WAL文件(`*.db-wal`, `*.db-shm`)丢失时，SQLite无法打开数据库
- 这通常发生在进程异常退出或系统崩溃后

## 解决方案

### 自动修复（推荐）
应用程序现在包含自动恢复功能：
1. 检测到数据库连接错误时自动尝试恢复
2. 尝试将数据库从WAL模式切换到DELETE模式
3. 如果失败，会删除损坏的WAL文件并重新连接

### 手动修复
如果自动修复失败，可以手动执行以下命令：
```bash
# 将数据库切换到DELETE模式（不依赖WAL文件）
sqlite3 depmap_cache.db "PRAGMA journal_mode = DELETE;"

# 验证数据库是否可访问
sqlite3 depmap_cache.db ".tables"

# 测试应用程序
./depmap-downloader update
```

## 代码改进
为了防止类似问题再次发生，我们添加了以下改进：

1. **智能数据库连接**：
   - 使用 `mode=rwc` 连接参数，允许数据库自动创建
   - 区分数据库不存在和WAL文件损坏的情况
   - 为新数据库创建提供更好的错误处理

2. **错误检测和恢复**：
   - 检测SQLITE数据库连接错误
   - 自动尝试从WAL模式恢复
   - 仅在数据库文件存在时尝试WAL恢复

3. **容错的WAL模式设置**：
   - 优先尝试启用WAL模式以获得更好性能
   - 如果失败，自动回退到DELETE模式
   - 提供详细的错误日志和恢复状态信息

4. **更好的错误处理**：
   - 提供更详细的错误信息和调试日志
   - 添加恢复过程的日志记录
   - 改进数据库表结构，修复列不匹配问题

5. **创建目录支持**：
   - 自动创建数据库文件的父目录
   - 支持在任意目录中运行应用程序

## 预防措施
1. 确保应用程序正常关闭
2. 避免强制终止进程
3. 定期备份数据库文件
4. 使用最新的修复版本

现在应用程序应该能够正常工作，即使遇到类似的问题也能自动恢复。
